<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChytrÃ© jÃ¡</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="src/css/style.css">
  <link rel="icon" type="image/png" href="images/microphone-192.png">
</head>

<body>
  <div class="container">
    <div class="top-half">
      <img src="images/microphone-192.png" alt="Microphone" id="start-speech" class="mic-icon">

    </div>
    <div class="bottom-half">
      <div id="output">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. 'Zobraz vytÃ­Å¾enÃ­', 'PÅ™ehrÃ¡t video Å¡kolenÃ­', nebo 'SpusÅ¥ audio nÃ¡vod'.</div>
    </div>
    <button id="installPWA" style="display: none;">ğŸ“² Nainstalovat aplikaci</button>


  </div>
  <script src="src/js/app.js" type="module"></script>
  <script src="src/js/install.js" type="module"></script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("public/sw.js")
        .then(() => console.log("Service Worker zaregistrovÃ¡n!"))
        .catch((err) => console.log("Service Worker error:", err));
    }
  </script>

  <script>
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
      console.error('âŒ HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ nenÃ­ podporovÃ¡no.');
      alert('HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ nenÃ­ podporovÃ¡no. Zkuste to v Chrome nebo na jinÃ©m zaÅ™Ã­zenÃ­.');
      document.getElementById('start-speech').disabled = true;
      throw new Error('SpeechRecognition not supported');
    }

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'cs-CZ';
    recognition.interimResults = false;
    recognition.continuous = false;

    let isProcessing = false; // OmezenÃ­ vÃ­ce poÅ¾adavkÅ¯ najednou
    let latestRequestTimestamp = 0; // SledovÃ¡nÃ­ nejnovÄ›jÅ¡Ã­ho poÅ¾adavku

    recognition.onerror = (event) => {
      console.error('âŒ Chyba pÅ™i hlasovÃ©m rozpoznÃ¡vÃ¡nÃ­:', event.error);
      alert(`Chyba pÅ™i rozpoznÃ¡vÃ¡nÃ­ hlasu: ${event.error}. Zkontrolujte povolenÃ­ mikrofonu.`);
      document.getElementById('start-speech').classList.remove('recording');
      isProcessing = false;
    };

    recognition.onend = () => {
      console.log('ğŸ”‡ HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ ukonÄeno.');
      document.getElementById('start-speech').classList.remove('recording');
      isProcessing = false;
    };

    document.getElementById('start-speech').addEventListener('click', () => {
      if (isProcessing) {
        console.log('â³ JinÃ½ poÅ¾adavek se jiÅ¾ zpracovÃ¡vÃ¡. PoÄkejte prosÃ­m.');
        return;
      }
      console.log('ğŸ¤ Poklep na mikrofon â€“ spouÅ¡tÃ­m hlasovÃ© rozpoznÃ¡vÃ¡nÃ­...');
      if (!recognition) {
        console.error('âŒ SpeechRecognition nenÃ­ inicializovÃ¡no.');
        alert('HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ nenÃ­ k dispozici. Zkuste obnovit strÃ¡nku nebo zkontrolovat prohlÃ­Å¾eÄ.');
        return;
      }
      recognition.start();
      document.getElementById('start-speech').classList.add('recording');
      isProcessing = true;

      // AutomatickÃ© zastavenÃ­ po 10 sekundÃ¡ch
      setTimeout(() => {
        if (recognition) {
          console.log('ğŸ”‡ HlasovÃ© rozpoznÃ¡vÃ¡nÃ­ automaticky ukonÄeno po 10 sekundÃ¡ch.');
          recognition.stop();
          document.getElementById('start-speech').classList.remove('recording');
          isProcessing = false;
        }
      }, 10000);
    });

    recognition.onresult = (event) => {
      const command = event.results[0][0].transcript.trim().toLowerCase();
      console.log(`ğŸ™ï¸ RozpoznanÃ½ pÅ™Ã­kaz: ${command}`);
      document.getElementById('output').innerText = `RozpoznÃ¡no: ${command}`;
      recognition.stop();
      handleCommand(command);
    };

    async function handleCommand(command) {
      console.log("ğŸ¤ OdesÃ­lÃ¡m povel na Make:", command);

      const webhookUrl = "https://hook.eu1.make.com/17gn7hrtmnfgsykl52dcn2ekx15nvh1f"; // Aktualizuj URL

      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ Povel: command })
        });

        console.log("ğŸ” HTTP status:", response.status);

        if (!response.ok) {
          throw new Error(`Chyba pÅ™i odesÃ­lÃ¡nÃ­ na Make: ${response.status}`);
        }

        const text = await response.text();
        console.log("ğŸ“œ SurovÃ¡ odpovÄ›Ä:", text);

        try {
          const result = JSON.parse(text);
          console.log("âœ… ZpracovanÃ¡ odpovÄ›Ä (JSON):", result);

          if (Array.isArray(result.url)) {
            console.log("ğŸ“‹ Seznam URL detekovÃ¡n:", result.url);
            // Zde mÅ¯Å¾eÅ¡ zobrazit seznam, pokud chceÅ¡ uÅ¾ivateli nabÃ­dnout vÃ­ce moÅ¾nostÃ­
          } else if (typeof result.url === "string") {
            console.log("ğŸš€ PÅ™esmÄ›rovÃ¡nÃ­ na jednu URL:", result.url);
            window.location.href = result.url; // PÅ™esmÄ›rovÃ¡nÃ­ na URL
          } else {
            console.error("âŒ OdpovÄ›Ä z Make neobsahuje platnou URL:", result);
            document.getElementById('output').innerText = "âš ï¸ ChybnÃ¡ odpovÄ›Ä z Make.";
          }
        } catch (error) {
          console.error("âŒ Chyba pÅ™i parsovÃ¡nÃ­ JSON odpovÄ›di:", error, "OdpovÄ›Ä:", text);
          document.getElementById('output').innerText = "âš ï¸ Chyba pÅ™i zpracovÃ¡nÃ­ odpovÄ›di.";
        }

      } catch (error) {
        console.error("âŒ Chyba pÅ™i komunikaci s Make:", error);
        document.getElementById('output').innerText = "âš ï¸ Chyba pÅ™i pÅ™ipojenÃ­.";
      }
    }


    function displayContent(url) {
      const output = document.getElementById('output');
      output.innerText = `NaÄÃ­tÃ¡m obsah: ${url}`;

      // Zkontrolujeme, zda je URL platnÃ¡
      if (!url || typeof url !== 'string') {
        output.innerHTML = '<span class="status">Soubor nenalezen</span><br><span class="hint">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. "Zobraz vytÃ­Å¾enÃ­", "PÅ™ehrÃ¡t video Å¡kolenÃ­", nebo "SpusÅ¥ audio nÃ¡vod".</span>';
        return;
      }

      // RozpoznÃ¡nÃ­ typu URL a zobrazenÃ­ v frame nebo chybovÃ¡ hlÃ¡Å¡ka
      if (url.includes('.mp3') || url.includes('.wav') || url.includes('podcasty.seznam.cz')) {
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = url;
        audio.onerror = () => {
          output.innerHTML = '<span class="status">Soubor nenalezen</span><br><span class="hint">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. "Zobraz vytÃ­Å¾enÃ­", "PÅ™ehrÃ¡t video Å¡kolenÃ­", nebo "SpusÅ¥ audio nÃ¡vod".</span>';
        };
        audio.onloadedmetadata = () => {
          output.innerHTML = '';
          output.appendChild(audio);
        };
        output.innerHTML = ''; // VyÄistÃ­me pÅ™ed pÅ™idÃ¡nÃ­m audia
      } else if (url.includes('youtube.com') || url.includes('vimeo.com') || url.includes('.mp4') || url.includes('.webm')) {
        let mediaElement;
        if (url.includes('youtube.com')) {
          const youtubeId = new URL(url).searchParams.get('v') || url.split('v=')[1]?.split('&')[0];
          if (youtubeId) {
            mediaElement = document.createElement('iframe');
            mediaElement.width = window.innerWidth > 768 ? '533' : '100%'; // ZachovÃ¡me zvÄ›tÅ¡enÃ­ na 533px na desktopu, 100% na mobilu
            mediaElement.height = window.innerWidth > 768 ? '300' : '400'; // ZachovÃ¡me vÃ½Å¡ku 300px na desktopu, vrÃ¡tÃ­me 400px na mobilu
            mediaElement.style.width = '533px !important'; // PÅ™idÃ¡me inline style pro prioritu
            mediaElement.style.height = window.innerWidth > 768 ? '300px !important' : '400px !important'; // PÅ™idÃ¡me inline style pro prioritu
            mediaElement.style.objectFit = window.innerWidth > 768 ? 'cover' : 'contain'; // ZachovÃ¡me cover na desktopu, contain na mobilu
            mediaElement.src = `https://www.youtube.com/embed/${youtubeId}?autoplay=1&enablejsapi=1`; // PÅ™idÃ¡me enablejsapi pro kontrolu pÅ™es API
            mediaElement.allow = 'autoplay; encrypted-media; fullscreen';
            mediaElement.allowFullscreen = true;
            // Pokus o nastavenÃ­ velikosti pÅ™es YouTube API
            mediaElement.onload = () => {
              if (window.YT && window.YT.Player) {
                new window.YT.Player(mediaElement, {
                  events: {
                    'onReady': function (event) {
                      event.target.setSize(
                        window.innerWidth > 768 ? 533 : 100, // Å Ã­Å™ka na desktopu/mobilu
                        window.innerWidth > 768 ? 300 : 400 // VÃ½Å¡ka na desktopu/mobilu
                      );
                    }
                  }
                });
              }
            };
          }
        } else if (url.includes('vimeo.com')) {
          const vimeoId = url.split('/').pop();
          if (vimeoId) {
            mediaElement = document.createElement('iframe');
            mediaElement.width = window.innerWidth > 768 ? '533' : '100%'; // ZachovÃ¡me zvÄ›tÅ¡enÃ­ na 533px na desktopu, 100% na mobilu
            mediaElement.height = window.innerWidth > 768 ? '300' : '400'; // ZachovÃ¡me vÃ½Å¡ku 300px na desktopu, vrÃ¡tÃ­me 400px na mobilu
            mediaElement.style.width = '533px !important'; // PÅ™idÃ¡me inline style pro prioritu
            mediaElement.style.height = window.innerWidth > 768 ? '300px !important' : '400px !important'; // PÅ™idÃ¡me inline style pro prioritu
            mediaElement.style.objectFit = window.innerWidth > 768 ? 'cover' : 'contain'; // ZachovÃ¡me cover na desktopu, contain na mobilu
            mediaElement.src = `https://player.vimeo.com/video/${vimeoId}?autoplay=1`; // PÅ™idÃ¡me autoplay
            mediaElement.allow = 'autoplay; encrypted-media; fullscreen';
            mediaElement.allowFullscreen = true;
          }
        } else {
          mediaElement = document.createElement('video');
          mediaElement.controls = true;
          mediaElement.width = window.innerWidth > 768 ? 533 : '100%'; // ZachovÃ¡me zvÄ›tÅ¡enÃ­ na 533px (16:9 pro 300px vÃ½Å¡ku) na desktopu, 100% na mobilu
          mediaElement.height = window.innerWidth > 768 ? 300 : '400'; // ZachovÃ¡me vÃ½Å¡ku 300px na desktopu, vrÃ¡tÃ­me 400px na mobilu
          mediaElement.style.width = '533px !important'; // PÅ™idÃ¡me inline style pro prioritu
          mediaElement.style.height = window.innerWidth > 768 ? '300px !important' : '400px !important'; // PÅ™idÃ¡me inline style pro prioritu
          mediaElement.style.objectFit = window.innerWidth > 768 ? 'cover' : 'contain'; // ZachovÃ¡me cover na desktopu, contain na mobilu
          mediaElement.src = url;
          mediaElement.autoplay = true; // PÅ™idÃ¡me autoplay pro okamÅ¾itÃ© pÅ™ehrÃ¡vÃ¡nÃ­
        }
        if (mediaElement) {
          mediaElement.onerror = () => {
            output.innerHTML = '<span class="status">Soubor nenalezen</span><br><span class="hint">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. "Zobraz vytÃ­Å¾enÃ­", "PÅ™ehrÃ¡t video Å¡kolenÃ­", nebo "SpusÅ¥ audio nÃ¡vod".</span>';
          };
          output.innerHTML = '';
          output.appendChild(mediaElement);
        } else {
          output.innerHTML = '<span class="status">Soubor nenalezen</span><br><span class="hint">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. "Zobraz vytÃ­Å¾enÃ­", "PÅ™ehrÃ¡t video Å¡kolenÃ­", nebo "SpusÅ¥ audio nÃ¡vod".</span>';
        }
      } else if (url.includes('.pdf') || url.includes('.xls') || url.includes('.xlsx') || url.includes('.ppt') || url.includes('.pptx') || url.includes('.doc') || url.includes('.docx')) {
        const iframe = document.createElement('iframe');
        iframe.width = '100%';
        iframe.height = '500px'; // StandardnÃ­ vÃ½Å¡ka pro dokumenty
        iframe.src = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        iframe.onerror = () => {
          output.innerHTML = '<span class="status">Soubor nenalezen</span><br><span class="hint">Å˜eknÄ›te pÅ™Ã­kaz, napÅ™. "Zobraz vytÃ­Å¾enÃ­", "PÅ™ehrÃ¡t video Å¡kolenÃ­", nebo "SpusÅ¥ audio nÃ¡vod".</span>';
        };
        output.innerHTML = '';
        output.appendChild(iframe);
      } else if (url.includes('app.tabidoo.cloud/public-dashboard') || url.includes('public') || url.includes('dashboard')) {
        // OtevÅ™enÃ­ veÅ™ejnÃ½ch dashboardÅ¯ na samostatnÃ© strÃ¡nce
        window.location.href = url;
      } else {
        // OstatnÃ­ URL (strÃ¡nky, grafy) otevÅ™eme na samostatnÃ© strÃ¡nce
        window.location.href = url;
      }
    }

    let deferredPrompt;
    const installButton = document.getElementById("install-button");

    // âœ… Funkce pro kontrolu, zda je PWA uÅ¾ nainstalovanÃ¡
    function checkIfInstalled() {
      if (window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone) {
        console.log("âœ… Aplikace bÄ›Å¾Ã­ jako PWA, skryjeme tlaÄÃ­tko.");
        installButton.style.display = "none"; // Ihned skryjeme tlaÄÃ­tko
      }
    }

    // âœ… Zkontrolujeme instalaci ihned po naÄtenÃ­ strÃ¡nky
    document.addEventListener("DOMContentLoaded", checkIfInstalled);

    // âœ… KdyÅ¾ se nabÃ­dne instalace PWA
    window.addEventListener("beforeinstallprompt", (event) => {
      event.preventDefault(); // ZabrÃ¡nÃ­me vÃ½chozÃ­mu chovÃ¡nÃ­
      deferredPrompt = event;

      // ZobrazÃ­me tlaÄÃ­tko, ale bez "mrknutÃ­"
      setTimeout(() => {
        document.getElementById("install-button").style.opacity = "1";
      }, 100);
    });


    // âœ… UdÃ¡lost, kterÃ¡ se spustÃ­ ihned po instalaci PWA
    window.addEventListener("appinstalled", () => {
      console.log("ğŸ‰ UdÃ¡lost `appinstalled` spuÅ¡tÄ›na, skryjeme tlaÄÃ­tko.");
      installButton.style.display = "none";
    });

    // âœ… Extra kontrola kaÅ¾dou sekundu, zda je PWA aktivnÃ­
    setInterval(checkIfInstalled, 1000);


  </script>

</body>

</html>